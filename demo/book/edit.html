<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>数据列表</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-status-bar-style" content="black"> 
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <link rel="stylesheet" href="../../lib/layui/css/layui.css">
  <link rel="stylesheet" type="text/css" href="../../css/hp-common.css"/>
  <style type="text/css">
    #cvPopup .img-box, #roleShow .img-box, #roleAdded .img-box, #addNewStaff .img-box , #addedStaff .img-box{
      float: left;
      position: relative;
      margin: 10px 0 0 15px;
      width: 110px;
      overflow: hidden;
      text-align: center;
      cursor: pointer;
      border: 2px solid #fff;
    }
    #addedStaff .img-box{
      padding: 0 10px;
      width: 50px;
    }
    #cvPopup .img-box.active, #roleShow .img-box.active, #roleAdded .img-box.active, #addNewStaff .img-box.active, #addedStaff .img-box.active{
      border-color: #009688;
    }
    .active:after{
      position: absolute;
      content: '';
      bottom: 6px;
      right: 1px;
      width: 18px;
      height: 9px;
      border-left: 4px solid #009688;
      border-bottom: 4px solid #009688;
      transform: rotate(-45deg);
    }
    #addedStaff .img-box.active:after{
      border-left: 2px solid #009688;
      border-bottom: 2px solid #009688;
    }
    #surePopup, #sureTagPopup{
      display: none;
      position: absolute;
      background-color: rgba(0, 0, 0, .6);
      width: 200px;
      height: 100px;
      top:  50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
    }
    #surePopup a, #sureTagPopup a{
      height: 28px;
      line-height: 28px;
      margin: 0px 5px;
      padding: 5px 15px;
      background-color: #fff;
      color: #333;
      border-radius: 2px;
      font-weight: 400;
      cursor: pointer;
      text-decoration: none;
    }
    #surePopup .content , #sureTagPopup .content{
      position: relative;
      padding: 20px;
      line-height: 24px;
      word-break: break-all;
      overflow: hidden;
      font-size: 14px;
      overflow-x: hidden;
      overflow-y: auto;
      text-align: center;
    }
    #surePopup .btn-group, #sureTagPopup .btn-group{
      text-align: center;
    }
    #surePopup .btn-group .sure-btn, #sureTagPopup .btn-group .sure-btn{
      color: #fff;
      background-color: #009688;
    }
    #surePopup .btn-group .cel-btn, #sureTagPopup .btn-group .cel-btn{
      color: #fff;
      background-color: #FF5722;
    }
    #tagWrap .layui-btn-warm{
      position: relative;
      margin-left: 20px;
      margin-top: 20px;
    }
    #tagWrap .layui-btn-warm.active:after{
      position: absolute;
      content: '';
      bottom: 6px;
      right: 1px;
      width: 18px;
      height: 9px;
      border-left: 2px solid #009688;
      border-bottom: 2px solid #009688;
      transform: rotate(-45deg);
    }
  </style>
</head>

<body>
  <div class="layui-tab layui-tab-brief" lay-filter="addInfo">
    <ul class="layui-tab-title">
      <li class="layui-this">书籍基本信息</li>
      <li>书籍主要角色信息</li>
      <li>书籍单行本信息</li>
      <li>书籍标签信息</li>
    </ul>
    <div class="layui-tab-content">
      <div class="layui-tab-item layui-show">
        <form class="layui-form" id="banBaseForm">
          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">书籍名</label>
              <div class="layui-input-inline">
                <input type="text" name="name" placeholder="请输入书籍名" class="layui-input">
              </div>
            </div>
          </div>
          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">中文书籍名</label>
              <div class="layui-input-inline">
                <input type="text" name="cnname" placeholder="请输入中文书籍名" class="layui-input">
              </div>
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">地区</label>
            <div class="layui-input-inline">
              <select name="addr" class="selectAddr" id="selectAddr">
                <option value=""></option>
                <option value="0">中国</option>
                <option value="1">日本</option>
                <option value="2">美国</option>
                <option value="3">其他</option>
              </select>
            </div>
          </div>
          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">作者</label>
              <div class="layui-input-inline">
                <input type="text" name="author" placeholder="请输入作者" class="layui-input">
              </div>
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">类型</label>
            <div class="layui-input-inline">
              <select name="type" class="selectType" id="selectType">
                <option value=""></option>
                <option value="0">漫画</option>
                <option value="1">小说</option>
                <option value="2">画集</option>
                <option value="3">其他</option>
              </select>
            </div>
          </div>
          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">开始连载时间</label>
              <div class="layui-input-inline">
                <input type="text" name="start_date" id="startDate" placeholder="请输入开始连载时间" class="layui-input">
              </div>
            </div>
          </div>
          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">话数</label>
              <div class="layui-input-inline">
                <input type="text" name="chapter" placeholder="请输入话数" class="layui-input">
              </div>
            </div>
          </div>
          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">出版社</label>
              <div class="layui-input-inline">
                <input type="text" name="press" placeholder="请输入出版社" class="layui-input">
              </div>
            </div>
          </div>
          <div class="layui-upload">
            <div style="display: none;">
              <canvas id="banCanvas" height="100" width="150"></canvas>
            </div>
            <label class="layui-form-label">书籍封面图</label>
            <div class="layui-upload-list" style="margin: 0;display: inline-block;vertical-align: bottom;">
              <img id="showBanImage" width="160" height="260">
            </div>
            <button type="button" class="layui-btn" id="selBanImage">选择图片</button>
          </div>
          <div style="display: none;">
            <input type="text" name="id">
            <input type="text" name="show_pic" value="" id="showBanPic">
            <input type="text" name="small_show_pic" value="" id="smallBanPic">
          </div>
          <a class="layui-btn" style="float: right; margin-right: 40px;" id="submitBanBase">修改书籍基本信息</a>
        </form>
      </div>

      <div class="layui-tab-item">
        <a class="layui-btn" id="addRoleBtn">添加关联角色</a>
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
          <legend>已有关联角色</legend>
        </fieldset>
        <div id="roleAdded"></div>
      </div>

      <div class="layui-tab-item">
        <a class="layui-btn" id="addEpisodeBtn">添加单行本</a>
        <table id="episodeData" lay-filter="episodeData"></table>
      </div>

      <div class="layui-tab-item">
        <a class="layui-btn" id="addTag">添加标签</a>
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
          <legend>已加入标签</legend>
        </fieldset>
        <div id="addedTagPopup"></div>
      </div>
    </div>
  </div>
  <!--添加集数弹层 start-->
  <div id="addEpisodePopup" style="display: none">
    <form class="layui-form" id="addEpisodeForm" style="margin-top: 20px;">
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">单行本号</label>
          <div class="layui-input-inline">
            <input type="text" name="off_no" placeholder="请输入集号" class="layui-input">
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">单行本名称</label>
          <div class="layui-input-inline">
            <input type="text" name="name" placeholder="请输入集号" class="layui-input">
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">单行本中文名称</label>
          <div class="layui-input-inline">
            <input type="text" name="cnname" placeholder="请输入标题" class="layui-input">
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">开始连载时间</label>
          <div class="layui-input-inline">
            <input type="text" name="broadcast_time" id="addBroadcastTime" class="layui-input">
          </div>
        </div>
      </div>
      <div class="layui-upload">
        <div style="display: none;">
          <canvas id="OffCanvas" height="100" width="150"></canvas>
        </div>
        <label class="layui-form-label">单行本封面图</label>
        <div class="layui-upload-list" style="margin: 0;display: inline-block;vertical-align: bottom;">
           <img id="showOffImage" width="160" height="260">
        </div>
        <button type="button" class="layui-btn" id="selOffImage">选择图片</button>
      </div>
      <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">内容简介</label>
        <div class="layui-input-block" style="margin: 20px 0 0 130px;">
          <textarea name="detail" id="addEpisodeDetail" class="layui-hide"> </textarea>
        </div>
      </div>
      <div style="display: none">
        <input type="text" name="bookId">
        <input type="text" name="show_pic" value="" id="showOffPic">
        <input type="text" name="small_show_pic" value="" id="smallOffPic">
      </div>
    </form>
    <a id="addEpisode" class="layui-btn" style="margin-left: 110px;margin-top: 20px;">添加</a>
  </div>
  <!--添加集数弹层 end-->

  <!--添加角色弹层 start-->
  <div id="roleEditPopup" style="display: none;">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
      <legend>角色名字</legend>
    </fieldset>
    <div class="layui-form-item">
      <div class="layui-inline">
        <label class="layui-form-label">角色名</label>
        <div class="layui-input-inline">
          <input type="text" name="roleName" class="layui-input">
        </div>
        <a class="layui-btn" id="selRole">搜索</a>
      </div>
    </div>
    <fieldset class="layui-elem-field layui-field-title">
      <legend>角色选择或添加</legend>
    </fieldset>
    <div class="layui-tab layui-tab-brief" lay-filter="addRoleInfo">
      <ul class="layui-tab-title">
        <li class="layui-this">已有角色</li>
        <li>新建角色</li>
      </ul>
      <div class="layui-tab-content">
        <div class="layui-tab-item layui-show" id="roleShow">
          <form class="layui-form" id="showcvForm">
            <div class="layui-form-item">
              <div class="layui-inline">
                <a class="layui-btn" id="addHaveRole">添加关联角色</a>
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label" style="width: 40px;">角色</label>
              <div class="layui-input-block">
                <input type="radio" name="position" value="0" title="主角" checked="">
                <input type="radio" name="position" value="1" title="配角">
              </div>
            </div>
          </form>
          <div style="overflow: hidden;clear: both;"></div>
          <div id="roleShowPopup"></div>
        </div>
        <div class="layui-tab-item">
          <form class="layui-form" id="roleForm">
            <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">角色姓名</label>
                <div class="layui-input-inline">
                  <input type="text" name="name" placeholder="请输入角色姓名" class="layui-input">
                </div>
              </div>
            </div>
            <div class="layui-form-item">
              <div class="layui-block">
                <label class="layui-form-label">角色别名</label>
                <div class="layui-input-block">
                  <input type="text" name="cnname" placeholder="请输入角色别名，多个用','隔开" class="layui-input">
                </div>
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">性别</label>
              <div class="layui-input-block">
                <input type="radio" name="sex" value="男" title="男" checked="">
                <input type="radio" name="sex" value="女" title="女">
              </div>
            </div>
            <div class="layui-form-item">
              <label class="layui-form-label">角色</label>
              <div class="layui-input-block">
                <input type="radio" name="position" value="0" title="主角" checked="">
                <input type="radio" name="position" value="1" title="配角">
              </div>
            </div>
            <div class="layui-form-item layui-form-text">
              <label class="layui-form-label">人物详情</label>
              <div class="layui-input-block">
                <!-- <textarea placeholder="请输入内容" class="layui-textarea" name="detail"></textarea> -->
                <textarea name="detail" id="roleDetail" class="layui-hide"> </textarea>
              </div>
            </div>
            <div style="display: none">
              <input type="text" name="show_pic" value="" id="showPic">
              <input type="text" name="small_show_pic" value="" id="smallshowPic">
              <input type="text" name="bangumiId">
              <input type="text" name="cvId">
            </div>
          </form>
          <div class="layui-upload">
            <div style="display: none;">
              <canvas id="addRoleCanvas" height="138" width="138"></canvas>
            </div>
            <label class="layui-form-label">角色头像</label>
            <div class="layui-upload-list" style="margin: 0;display: inline-block;vertical-align: bottom;">
              <img id="showImage" width="160" height="260">
              <p id="demoText"></p>
            </div>
            <button type="button" class="layui-btn" id="selectImage">选择图片</button>
          </div>
          <a id="addRole" class="layui-btn" style="margin-left: 110px;margin-top: 20px;">添加角色</a>
        </div>
      </div>
    </div>
  </div>
  <!--添加角色弹层 end-->

  <!--角色编辑弹层 start-->
  <div id="editActorPopup" style="display: none">
    <form class="layui-form" id="editActorForm" style="margin-top: 20px;">
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">角色姓名</label>
          <div class="layui-input-inline">
            <input type="text" name="name" placeholder="请输入角色姓名" class="layui-input">
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-block">
          <label class="layui-form-label">角色别名</label>
          <div class="layui-input-block">
            <input type="text" name="cnname" placeholder="请输入角色别名，多个用','隔开" class="layui-input">
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">性别</label>
        <div class="layui-input-block">
          <input type="radio" name="sex" value="男" title="男">
          <input type="radio" name="sex" value="女" title="女">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">角色</label>
        <div class="layui-input-block">
          <input type="radio" name="position" value="0" title="主角">
          <input type="radio" name="position" value="1" title="配角">
        </div>
      </div>
      <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">人物详情</label>
        <div class="layui-input-block">
          <!-- <textarea placeholder="请输入内容" class="layui-textarea" name="detail"></textarea> -->
          <textarea name="detail" id="eaDetail" class="layui-hide"> </textarea>
        </div>
      </div>
      <div style="display: none">
        <input type="text" name="show_pic" value="" id="eashowPic">
        <input type="text" name="small_show_pic" value="" id="easmallshowPic">
        <input type="text" name="bangumiId">
        <input type="text" name="oldcvId">
        <input type="text" name="cvId">
        <input type="text" name="roleId">
      </div>
    </form>
    <div class="layui-upload">
      <div style="display: none;">
        <canvas id="editRoleCanvas" height="138" width="138"></canvas>
      </div>
      <label class="layui-form-label">角色头像</label>
      <div class="layui-upload-list" style="margin: 0;display: inline-block;vertical-align: bottom;">
        <img id="eashowImage" width="160" height="260">
      </div>
      <button type="button" class="layui-btn" id="easelectImage">选择图片</button>
    </div>
    <a id="eaeditRole" class="layui-btn" style="margin-left: 110px;margin-top: 20px;">修改角色</a>
    <a id="delRole" class="layui-btn layui-btn-danger" style="margin-top: 20px;">删除角色</a>
  </div>
  <!--角色编辑弹层 end-->

  <!--编辑集数弹层 start-->
  <div id="editEpisodePopup" style="display: none">
    <form class="layui-form" id="editEpisodeForm" style="margin-top: 20px;">
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">单行本序号</label>
          <div class="layui-input-inline">
            <input type="text" name="off_no" class="layui-input" readonly="true">
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">单行本名称</label>
          <div class="layui-input-inline">
            <input type="text" name="name" placeholder="请输入单行本名称" class="layui-input">
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">单行本中文名称</label>
          <div class="layui-input-inline">
            <input type="text" name="cnname" placeholder="请输入单行本中文名称" class="layui-input">
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">开始连载时间</label>
          <div class="layui-input-inline">
            <input type="text" name="broadcast_time" id="editBroadcastTime" class="layui-input">
          </div>
        </div>
      </div>
      <div class="layui-upload">
        <div style="display: none;">
          <canvas id="offdCanvas" height="100" width="150"></canvas>
        </div>
        <label class="layui-form-label">书籍封面图</label>
        <div class="layui-upload-list" style="margin: 0;display: inline-block;vertical-align: bottom;">
           <img id="showOffdImage" width="160" height="260">
        </div>
        <button type="button" class="layui-btn" id="selOffdImage">选择图片</button>
      </div>
      <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">内容简介</label>
        <div class="layui-input-block" style="margin: 20px 0 0 130px;">
          <textarea name="detail" id="editEpisodeDetail" class="layui-hide"> </textarea>
        </div>
      </div>
      <div style="display: none">
        <input type="text" name="bangumiId">
        <input type="text" name="show_pic" value="" id="showOffdPic">
        <input type="text" name="small_show_pic" value="" id="smallOffdPic">
      </div>
    </form>
  </div>
  <!--编辑集数弹层 end-->

  <!--确认删除集数提示框 start-->
  <div id="surePopup">
    <div class="sure-box">
      <div class="content">
        <p>确定删除该集</p>
      </div>
      <div class="btn-group">
        <a class="sure-btn" id="sureBtn">确定</a>
        <a class="cel-btn" id="celBtn">取消</a>
      </div>
    </div>
  </div>
  <!--确认删除标签提示框 end-->

  <!--确认删除标签 start-->
  <div id="sureTagPopup">
    <div class="sure-box">
      <div class="content">
        <p>确定删除该关联标签</p>
      </div>
      <div class="btn-group">
        <a class="sure-btn" id="sureTagBtn">确定</a>
        <a class="cel-btn" id="celTagBtn">取消</a>
      </div>
    </div>
  </div>
  <!--确认删除标签 end-->

  <!--添加标签弹层 start-->
  <div id="tagPopup" style="display: none;">
    <div id="tagWrap"></div>
  </div>
  <!--添加标签制作人员弹层 end-->
</body>

<script src="../../lib/layui/layui.js"></script> 
<!-- 表格工具条 -->
<script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn-xs" lay-event="editTab">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delTab">删除</a>
</script> 

<script>
  var idx = window.location.href.indexOf('?id=');
  var id  = -1;
  if( idx > 0){
    id = window.location.href.substring(idx+4);
  }
  layui.config({
    base: '../../module/' // 扩展模块目录
  }).extend({ // 模块别名
    hpTab: 'component/hpTab',
    hpRightMenu: 'component/hpRightMenu',
    hpFormAll: 'component/hpFormAll',
    hpLayedit: 'component/hpLayedit',
    hpTheme: 'component/hpTheme'
  });
  layui.use(['element', 'form', 'layedit', 'laydate', 'upload' ,'layer', 'hpLayedit', 'table'], function(){
    var $ = layui.jquery;
    var form    = layui.form;
    var table   = layui.table;
    var element = layui.element;
    var layer   = layui.layer;
    var upload  = layui.upload; 
    var laydate = layui.laydate;
    var layedit = layui.hpLayedit;
    var text;
    var eatext;
    var roleIndex;
    var sureCv;
    var sureCvId = -1;
    var staffRole;
    var staffRoleId;
    var sureRole;
    var sureRoleId;
    var delStaff;
    var delStaffId;
    var editRoleOb ={};
    var showRoleId = -1;
    var epiNo;
    var $name;
    var tagId;

    getBaseInfo(id);
    showAddTag(id);
    //修改基本信息
    $('#submitBanBase').click(function() {
      editBaseInfo(id);
    });
    //添加角色信息
    $('#addRole').click(function() {
      addRole();
    });
    //修改角色信息
    $('#eaeditRole').click(function() {
      editRole();
    }) 
    //删除角色，只是取消关联
    $('#delRole').click(function() {
      delRole();
    })
    //添加已有角色信息
    $('#addHaveRole').click(function() {
      addHaveRole();
    });
    //查询cv
    $('#selCv').click(function() {
      selectCv('roleForm', 'roleEditPopup', 'cvPopup'); 
    });
    $('#easelCv').click(function() {
      selectCv('editActorForm', 'editActorPopup', 'cvPopup');
    });
    //查询role
    $('#selRole').click(function() {
      selectRole();
    });
    //查询role
    $('#selcvName').click(function() {
      selectCv('showcvForm', 'roleEditPopup', 'cvPopup');
    });
    //添加集数信息
    $('#addEpisode').click(function() {
      addEpisode();
    })
    //查询staff人物
    $('#selStaffBtn').click(function() {
      selStaff();
    });
    //添加staff人物
    $('#addStaffBtn').click(function() {
      addStaff();
    });
    //删除staff人物
    $('#delStaffBtn').click(function() {
      deleteStaff();
    });
    //上传staff人物信息
    $('#addStaffTotal').click(function() {
      addStaffTotal(id);
    });
    //确认删除集数
    $('#sureBtn').click(function() {
      var params = {
        id: id,
        off_no: epiNo
      }

      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bookManage/delOffprint',
        data: params,
        method: 'POST',
        success: function(res) {
          if(res.code === '11000'){
             $('#surePopup').hide();
            layer.msg(res.msg, {icon: 1, time: 1500});
            setTimeout(function(){
              tableEpisodeReload();
            }, 2000);
          }
        }
       });
    });
    //确认删除关联标签
    $('#sureTagBtn').click(function() {

      var params = {
        tag_id: tagId,
        id: id
      }
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bookManage/delBanTag',
        data: params,
        method: 'POST',
        success: function(data){
          if(data.code === '11000'){
            $('#sureTagPopup').hide();
            layer.msg(data.msg, {icon: 1, time: 1000});
            setTimeout(function(){
              showAddTag(id);
            }, 1000);
          }
        },
        error: function(err){
          console.log(err);
        }
      });
    })
    //取消删除关联标签
    $('#celTagBtn').click(function() {
      $('#sureTagPopup').hide();
    })
    //取消删除集数
    $('#celBtn').click(function() {
      $('#surePopup').hide();
    });
    //显示标签信息
    $('#addTag').click(function() {
      showTag(id);
    })
    //监听tab
    element.on('tab(addInfo)', function(data) {});
    //监听添加角色tab
    element.on('tab(addRoleInfo)', function(data) {});
    //监听集数表
    table.render({
      elem: '#episodeData'
      ,url:'http://127.0.0.1:3000/api/manage/bookManage/showOffprint'
      ,where: {id: id}
      ,page: true
      ,cols: [[
        {field:'off_no', minWidth:80, title: '单行本序号'}
        ,{field:'name', minWidth:120, title: '单行本名称'}
        ,{field:'cnname', minWidth:120, title: '中文名称'}
        ,{field:'broadcast_time', minWidth:120, title: '开始连载时间'}
        ,{title: '操作', fixed: 'right', minWidth:150, align:'center', toolbar: '#barDemo'}
      ]]
    });

    //监听集数工具条
    table.on('tool(episodeData)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
      var data = obj.data;
      var layEvent = obj.event; 
      var tr = obj.tr; 
      var text;
      if(layEvent === 'editTab') { //跳转到编辑页
        epiNo = data.off_no;
        getEpisode();
      } else if(layEvent === 'delTab') { //删除
        epiNo = data.off_no;
        $('#surePopup').show();
      }
    });

    roleUploadImg('#selBanImage', 'showBanImage', 'showBanPic', 'smallBanPic', 'banCanvas');
    roleUploadImg('#selOffImage', 'showOffImage', 'showOffPic', 'smallOffPic', 'OffCanvas');
    roleUploadImg('#selOffdImage', 'showOffdImage', 'showOffdPic', 'smallOffdPic', 'OffdCanvas');
    roleUploadImg('#selectImage', 'showImage', 'showPic', 'smallshowPic', 'addRoleCanvas');
    roleUploadImg('#easelectImage', 'eashowImage', 'eashowPic', 'easmallshowPic', 'editRoleCanvas');
    //动态绑定声优选择事件
    $('#cvPopup').on('click', '.img-box', function(){
      var arr = $('#cvPopup').find('.active');
      for(var i = 0; i < arr.length; i++){
        $(arr).removeClass('active');
      } 
      sureCv = $(this).attr('data-name');
      sureCvId = $(this).attr('data-id');
      $(this).addClass('active');
    });

    //动态绑定角色编辑事件
    $('#roleShow').on('click', '.img-box', function(){
      var arr = $('#roleShow').find('.active');
      for(var i = 0; i < arr.length; i++){
        $(arr).removeClass('active');
      } 
      sureRole = $(this).attr('data-name');
      sureRoleId = $(this).attr('data-id');
      $(this).addClass('active');
    });

    //动态绑定staff选择事件
    $('#addNewStaff').on('click', '.img-box', function(){
      var arr = $('#addNewStaff').find('.active');
      for(var i = 0; i < arr.length; i++){
        $(arr).removeClass('active');
      } 
      staffRole = $(this).attr('data-name');
      staffRoleId = $(this).attr('data-id');
      $(this).addClass('active');
    });

    ////动态绑定已有staff选择事件
    $('#addedStaff').on('click', '.img-box', function(){
      var arr = $('#addedStaff').find('.active');
      for(var i = 0; i < arr.length; i++){
        $(arr).removeClass('active');
      } 
      delStaffId = $(this).attr('data-id');
      $(this).addClass('active');
    });

    //动态绑定角色选择事件
    $('#roleAdded').on('click', '.img-box', function(){
      //编辑弹出层
      var eabId = $(this).attr('data-bangumiid');
      var earId = $(this).attr('data-roleid');
      var eacId = $(this).attr('data-cvid');
      var posi  = $(this).attr('data-posi');
      var cvn   = $(this).attr('data-cvname');

      $('#editActorForm')[0].reset();
      $('#editActorForm input[name=bangumiId]').val(eabId);
      $('#editActorForm input[name=oldcvId]').val(eacId);
      $('#editActorForm input[name=cvId]').val(eacId);
      $('#editActorForm input[name=roleId]').val(earId);
      roleAddedIndex = layer.open({
        type: 1,
        title: '编辑人物信息',
        shadeClose: true,
        shade: false,
        maxmin: true, //开启最大化最小化按钮
        area: ['893px', '600px'],
        content: $('#editActorPopup'),
        success: function(data){
          //获取角色信息
          $.ajax({
            url: 'http://127.0.0.1:3000/api/manage/roleManage/roleInfo',
            data: {id: earId},
            method: 'POST',
            success: function(data){
              for(var i in data.data[0]){
                if( i != 'sex'){
                  $('#editActorForm input[name=' + i + ']').val(data.data[0][i]);
                }else{
                  $('#editActorForm input:radio[value = '+data.data[0].sex+']').attr('checked', 'true');
                }
              }
              $('#eaDetail').val(data.data[0].detail);
              $('#editActorForm input:radio[value = '+posi+']').attr('checked', 'true');
              $('#editActorForm input[name=cvname]').val(cvn);

              if(data.data[0].show_pic != ''){
                var imgUrl = 'e:/graduation';
                $('#eashowImage').attr('src', imgUrl + data.data[0].show_pic.substring(2));
              }
              //富文本编辑器
              eatext = layedit.build('eaDetail', {
                tool: [
                  'strong',
                  'italic',
                  'underline',
                  'del'
                ] 
              });
            },
            error: function(err){
              console.log(err);
            }
          })
        },
        btn: ['关闭'],
        yes: function(index, layero) {//关闭弹窗
          layer.close(index);        
        }
      })
    });

    //动态绑定标签添加事件
    $('#tagWrap').on('click', '.tagbtn', function(){
      if($(this).attr('class').indexOf('active') > -1){
        $(this).removeClass('active');
      }else{
        $(this).addClass('active');
      }
    });

    //动态绑定标签添加事件
    $('#addedTagPopup').on('click', '.tagbtn', function(){
      tagId = $(this).attr('data-id');
      $('#sureTagPopup').show();
    });

    //添加已有关联角色
    $('#roleShow').on('click', '.img-box', function() {
      showRoleId = $(this).attr('data-id');
    })

    //添加角色弹层
    $('#addRoleBtn').click(function() {

      $('#roleForm')[0].reset();
      roleIndex = layer.open({
        type: 1,
        title: '编辑人物信息',
        shadeClose: true,
        shade: false,
        maxmin: true, //开启最大化最小化按钮
        area: ['893px', '600px'],
        content: $('#roleEditPopup'),
        success: function(data){
          //富文本编辑器
          text = layedit.build('roleDetail', {
            tool: [
              'strong',
              'italic',
              'underline',
              'del'
            ] 
          });
        },
        btn: ['关闭'],
        yes: function(index, layero) {//关闭弹窗
          layer.close(index);        
        }
      })
    });

    //添加集数弹层
    $('#addEpisodeBtn').click(function() {
      $('#addEpisodeForm')[0].reset();
      episodeIndex = layer.open({
        type: 1,
        title: '编辑人物信息',
        shadeClose: true,
        shade: false,
        maxmin: true, //开启最大化最小化按钮
        area: ['893px', '600px'],
        content: $('#addEpisodePopup'),
        success: function(data){
          //富文本编辑器
          addEpisodetext = layedit.build('addEpisodeDetail', {
            tool: [
              'strong',
              'italic',
              'underline',
              'del'
            ] 
          });
          //时间选择器
          laydate.render({
            elem: '#addBroadcastTime'
          });
        },
        btn: ['关闭'],
        yes: function(index, layero) {//关闭弹窗
          layer.close(index);        
        }
      })
    });
    //添加staff弹层
    $('#staffForm .addStaffInfo').click(function(){
      $('#addedStaff').empty();
      $('#addNewStaff').empty();
      $name = $($(this).prev().find('input'));
      $('#addNewStaff').empty();
      
      //开启弹层
      staffIndex = layer.open({
        type: 1,
        title: '添加制作人员',
        shadeClose: true,
        shade: false,
        maxmin: true, //开启最大化最小化按钮
        area: ['893px', '600px'],
        content: $('#staffPopup'),
        success: function(data){
          if($name.val().length != 0){
            var nameValue = $name.val();
            var arr       = nameValue.split(',');
            for(var i  = 0; i < arr.length; i++){
              var str = '<div class="img-box" data-id=' + i + '>'+ ' <p>' + arr[i] + '</p>'+ '</div>';
              $('#addedStaff').append(str);
            }
          }
        },
        btn: ['关闭'],
        yes: function(index, layero) {//关闭弹窗
          $name = '';
          layer.close(index);        
        }
      });

    });
    //获取基本信息
    function getBaseInfo(bangumiId) {
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bookManage/showBaseInfo',
        data: {id: bangumiId},
        method: 'POST',
        success: function(data){
          var baseData = data.data.base;
          var roleData = data.data.role;
          var imgUrl = 'e:/graduation';

          for(var i in baseData[0]){
            if( i != 'start_date' ){
              $('#banBaseForm input[name = '+i+']').val(baseData[0][i]);
            }else{
              laydate.render({
                elem: '#startDate',
                value: baseData[0][i]
              });
            }
          }

          //角色信息添加
          if( baseData[0].show_pic ){
            $('#showBanImage').attr('src', imgUrl + baseData[0].show_pic.substring(2));
          }
          //设置select默认选择值
          $('.selectAddr option[value = ' + baseData[0].addr + ']').attr('selected', true);
          $('.selectType option[value = ' + baseData[0].type + ']').attr('selected', true);
          var ddArr = $('#banBaseForm .selectAddr').next().find('dd');
          $.each(ddArr, function(i,val){
            if($(val)[0].attributes[0].value == baseData[0].addr){
              $(val).addClass('layui-this');
              $($('#banBaseForm .selectAddr').next().find('.layui-select-title input')).val($(val).text());
            }
          });
          var ddArr = $('#banBaseForm .selectType').next().find('dd');
          $.each(ddArr, function(i,val){
            if($(val)[0].attributes[0].value == baseData[0].type){
              $(val).addClass('layui-this');
              $($('#banBaseForm .selectType').next().find('.layui-select-title input')).val($(val).text());
            }
          });

          //角色信息添加
          $('#roleAdded').empty();
          for(var i = 0; i < roleData.length; i++){
            var str = '<div class="img-box" data-bangumiId=' + roleData[i].bookId + ' data-roleId=' + roleData[i].roleId + ' data-posi=' + roleData[i].position + '>'+
                        '<img src="' + imgUrl + roleData[i].small_show_pic.substring(2) + '" width="110" height="110">'+
                        '<p>' + roleData[i].roleName + '</p>'+
                        '<p>' + (roleData[i].position == 0 ? '主角' : '配角') +'</p>'+ 
                      '</div>';
            $('#roleAdded').append(str);
          }
        },
        error: function(err){
         console.log(err);
        }
      });
    }
    //修改基本信息
    function editBaseInfo(bangumiId) {
      var data = $('#banBaseForm').serializeArray();

      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bookManage/editBookBaseInfo',
        data: data,
        method: 'POST',
        success: function(data) {
          if(data.code === '11000'){
            layer.msg(data.msg, {icon: 1});
            setTimeout(function(){
              getBaseInfo(bangumiId);
            }, 1000);
          }
        },
        error: function(err){
          console.log(err);
        }
      })
    }
    //添加角色信息
    function addRole() {
      $('#roleForm input[name=bangumiId]').val(id);
      if(sureCvId != -1){
        $('#roleForm input[name=cvId]').val(sureCvId);
      }
      var data = $('#roleForm').serializeArray();
      for(var i = 0; i < data.length; i++){
        if(data[i].name == 'detail'){
          data[i].value = layedit.getContent(text);
          break;
        }
      }
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bookManage/addRole',
        data: data,
        method: 'POST',
        success: function(data) {
          if(data.code === '11000'){
            layer.msg(data.msg, {icon: 1});
            setTimeout(function(){
              getBaseInfo(id);
              layer.close(roleIndex); 
            }, 1000);
          }
        },
        error: function(err){
          console.log(err);
        }
      })
    }
    //修改角色信息
    function editRole() {
      if(sureCvId != -1){
        $('#editActorForm input[name=cvId]').val(sureCvId);
      }
      var data = $('#editActorForm').serializeArray();
      for(var i = 0; i < data.length; i++){
        if(data[i].name == 'detail'){
          data[i].value = layedit.getContent(eatext);
          break;
        }
      }
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bookManage/editRole',
        data: data,
        method: 'POST',
        success: function(data){
          if(data.code == '11000'){
            layer.msg(data.msg, {icon: 1});
            setTimeout(function(){
              layer.close(roleAddedIndex);
              getBaseInfo(id);
            }, 1000);
          }
        },
        error: function(err){
          console.log(err);
        }
      })
    }
    //删除角色信息
    function delRole() {
      var params = {
        roleId: $('#editActorForm input[name = roleId]').val(),
        bangumiId: $('#editActorForm input[name = bangumiId]').val()
      }
      $.ajax({
        url:'http://127.0.0.1:3000/api/manage/bookManage/delActor',
        data: params,
        method: 'POST',
        success: function(data) {
          if(data.code == '11000'){
            layer.msg(data.msg, {icon: 1});
            setTimeout(function(){
              layer.close(roleAddedIndex);
              getBaseInfo(id);
            }, 1000);
          }
        },
        error: function(err) {
          console.log(err);
        }
      })
    }
    //添加已有角色信息
    function addHaveRole() {
      if(showRoleId != -1){
        
        var data = $('#showcvForm').serializeArray();
        var params = {
          bangumiId: id,
          cvId: sureCvId,
          roleId: showRoleId,
          position: data[0].value
        }
        $.ajax({
          url: 'http://127.0.0.1:3000/api/manage/bookManage/addLinkRole',
          data: params,
          method: 'POST',
          success: function(data) {
            if(data.code == '11000'){
              layer.msg(data.msg, {icon: 1});
              setTimeout(function(){
                layer.close(roleIndex);
                getBaseInfo(id);
              }, 1000);
            }
          },
          error: function(err) {
            console.log(err);
          }
        })
      }
    }
    //查询cv信息
    function selectCv(formId, popupId, cvpopup) {
      var name = $('#' + formId + ' input[name = cvname]').val();
      
      $('#' + cvpopup).empty();
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/staff/cvInfoArray',
        data: {name: name},
        method: 'POST',
        success: function(data){
          if(data.code === '11000'){
            if(data.data.length == 0){
              layer.msg('无任何cv信息，请先添加cv信息', {icon: 2});
            }else{
              var imgUrl = 'e:/graduation';
              $($('#' + popupId).parent().next().find('.layui-layer-min')).click();
              var cvIndex;
              for(var i in data.data){
                var str = '<div class="img-box" data-id=' + data.data[i].id + ' data-name=' + data.data[i].name + '>'+
                            '<img src="' + imgUrl + data.data[i].small_show_pic.substring(2) + '" width="110" height="69">'+
                            ' <p>' + data.data[i].name + ' / ' + data.data[i].cnname + '</p>'+
                          '</div>'
                $('#' + cvpopup).append(str);
              }
              cvIndex = layer.open({
                type: 1,
                title: 'cv信息',
                shadeClose: true,
                shade: false,
                maxmin: true, 
                area: ['893px', '600px'],
                content: $('#' + cvpopup),
                btn: ['确定'],
                yes: function(index, layero) {//选择cv
                  $('#' + formId + ' input[name=cvname]').val(sureCv);
                  layer.close(cvIndex);
                  $($('#' + popupId).parent().next().find('.layui-layer-max')).click();
                }
              })
            }
          }
        },
        error: function(err){
          console.log(err);
        }
      })
    }
    //查询role信息
    function selectRole() {
      var name = $('input[name=roleName]').val();
      $('#roleShowPopup').empty();

      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/roleManage/roleInfoArray',
        data: {name: name},
        method: 'POST',
        success: function(data) {
          if(data.code === '11000'){
            if(data.data.length == 0){
              layer.msg('无任何角色信息，请先添加角色信息', {icon: 2});
            }else{
              var imgUrl = 'e:/graduation';
              for(var i in data.data){
                var str = '<div class="img-box" data-id=' + data.data[i].id + ' data-name=' + data.data[i].name + '>'+
                            '<img src="' + imgUrl + data.data[i].small_show_pic.substring(2) + '" width="110" height="110">'+
                            ' <p>' + data.data[i].name + ' / ' + data.data[i].cnname + '</p>'+
                          '</div>'
                $('#roleShowPopup').append(str);
              }
            }
          }
        },
        error: function(err) {
          console.log(err);
        }
      });
    }
    //添加集数信息
    function addEpisode() {
      $('#addEpisodeForm input[name=bookId]').val(id);
      var data = $('#addEpisodeForm').serializeArray();

      for(var i = 0; i < data.length; i++){
        if(data[i].name == 'detail'){
          data[i].value = layedit.getContent(addEpisodetext);
          break;
        }
      }
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bookManage/addOffprint',
        data: data,
        method: 'POST',
        success: function(data){
          if(data.code == '11000'){
            layer.msg(data.msg, {icon: 1, time: 1500});
            setTimeout(function(){
              layer.close(episodeIndex);
              tableEpisodeReload();
            }, 2000);
          }else{
            console.log(res);
          }
        },
        error: function(err){
          console.log(err);
        }
      })
    }
    //获取集数信息
    function getEpisode() {
      var params = {
        id: id,
        off_no: epiNo
      }
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bookManage/getOffprintInfo',
        data: params,
        method: 'POST',
        success: function(data){
          if(data.code === '11000'){
            //富文本编辑器
            editEpisodetext = layedit.build('editEpisodeDetail', {
              tool: [
                'strong',
                'italic',
                'underline',
                'del'
              ] 
            });
            for(var i in data.data[0]){
              if( i != 'broadcast_time'){
                $('#editEpisodeForm input[name=' + i + ']').val(data.data[0][i]);
              }else{
                laydate.render({
                  elem: '#editBroadcastTime',
                  value: data.data[0][i]
                });
              }
            }
            var imgUrl = 'e:/graduation';
            $('#showOffdImage').attr('src', '');
            if( data.data[0].show_pic ){
              $('#showOffdImage').attr('src', imgUrl + data.data[0].show_pic.substring(2));
            }
            $('#editEpisodeDetail').val(data.data[0].detail);
            episodeIndex = layer.open({
              type: 1,
              title: '编辑单文本信息',
              shadeClose: true,
              shade: false,
              maxmin: true, //开启最大化最小化按钮
              area: ['893px', '600px'],
              content: $('#editEpisodePopup'),
              success: function(data){
               
              },
              btn: ['修改', '关闭'],
              yes: function(index, layero) {//关闭弹窗
                $('#editEpisodeForm input[name=bangumiId]').val(id);
                var data = $('#editEpisodeForm').serializeArray();
                
                for(var i = 0; i < data.length; i++){
                  if(data[i].name == 'detail'){
                    data[i].value = layedit.getContent(editEpisodetext);
                    break;
                  }
                }
                $.ajax({
                  url: 'http://127.0.0.1:3000/api/manage/bookManage/editOffprint',
                  data: data,
                  method: 'POST',
                  success: function(data){
                    if(data.code === '11000'){
                      layer.msg(data.msg, {icon: 1, time: 1500});
                      setTimeout(function(){
                        layer.close(index); 
                        tableEpisodeReload();
                      }, 2000);
                      
                    }
                  },
                  error: function(err){
                    console.log(err);
                  }
                }) 
              },
              btn2: function(index, layero){
                layer.close(index); 
              }
            });
          }
        },
        error: function(err){
          console.log(err);
        }
      });
      
    }
    //查询staff
    function selStaff(){
      var name = $('#staffPopup input[name=staffName]').val();

      $('#addNewStaff').empty();
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/staff/staffInfoArray',
        data: {name: name},
        method: 'POST',
        success: function(data){
          if(data.code === '11000'){
            if(data.data.length == 0){
              layer.msg('无任何制作人员信息，请先添加制作人员信息', {icon: 2});
            }else{
              var imgUrl = 'e:/graduation';
              for(var i in data.data){
                var str = '<div class="img-box" data-id=' + data.data[i].id + ' data-name=' + data.data[i].name + '>'+
                '<img src="' + imgUrl + data.data[i].small_show_pic.substring(2) + '" width="110" height="69">'+
                ' <p>' + data.data[i].name + ' / ' + data.data[i].cnname + '</p>'+
                '</div>'
                $('#addNewStaff').append(str);
              }
            }
          }
        },
        error: function(err){
          console.log(err);
        }
      });
    }
    //添加staff
    function addStaff(){ 
      if(staffRoleId != ''){
        var nameValue = ($name.val().length == 0 ? staffRole : $name.val() + ',' + staffRole);
        var idValue   = (typeof($name.attr('data-id')) == "undefined" || $name.attr('data-id').length == 0 ? staffRoleId : $name.attr('data-id') + ',' + staffRoleId);
        var arr       = nameValue.split(',');

        $('#addNewStaff').empty();
        $('#addedStaff').empty();
        for(var i  = 0; i < arr.length; i++){
          var str = '<div class="img-box" data-id=' + i + '>'+ ' <p>' + arr[i] + '</p>'+ '</div>';
          $('#addedStaff').append(str);
        }
        $name.attr('data-id', idValue);
        $name.val(nameValue);
        $('#staffPopup input[name=staffName]').val('');
        staffRole = '';
        staffRoleId = '';
      }
    }
    //删除staff
    function deleteStaff(){
      if(delStaffId != ''){
        var value = $name.val();
        var arr  = value.split(',');
        var idArr = $name.attr('data-id').split(',');
        var inputval;
        var idval;

        idArr.splice(delStaffId, 1);
        arr.splice(delStaffId,1);
        $('#addedStaff').empty();
        for(var i  = 0; i < arr.length; i++){
          var str  = '<div class="img-box" data-id=' + i + '>'+ '<p>' + arr[i] + '</p>'+ '</div>';

          $('#addedStaff').append(str);
          inputval = (typeof(inputval) == 'undefined' ? arr[i] : inputval + ',' + arr[i]);
          idval    = (typeof(idval) == 'undefined' || idval.length == 0 ? idArr[i] : idval + ',' + idArr[i]);
        }
        if(idArr.length == 0){
          idval = '';
        }
        $('#staffPopup input[name=staffName]').val('');
        $name.val(inputval);
        $name.attr('data-id', idval);
        delStaffId = '';
      }
     
    }
    //提交staff信息
    function addStaffTotal(bangumiId){
      var data  = $('#staffForm').serializeArray();
      var idArr = [];

      for(var i = 0; i < data.length; i++){
        var id = $('#staffForm input[name=' + data[i].name + ']').attr("data-id");
        idArr.push({id: (typeof(id) !== 'undefined' ? id : '')});
      }
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bgmiManage/saveStaffInfo',
        data: {
          name: data,
          id: idArr,
          bangumiId: bangumiId
        },
        method: 'POST',
        success: function(data){
          if(data.code == '11000'){
            layer.msg(data.msg, {icon: 1, time: 1500});
            setTimeout(function(){
              document.location.reload(true);
            }, 2000);
          }
        },
        error: function(err){
          console.log(err);
        }
      })
    }  
    //显示标签
    function showTag(bangumiId){
      $('#tagWrap').empty();
      var tagIndex = layer.open({
        type: 1,
        title: '添加标签信息',
        shadeClose: true,
        shade: false,
        maxmin: true, //开启最大化最小化按钮
        area: ['893px', '600px'],
        content: $('#tagPopup'),
        success: function(data){
        $.ajax({
          url: 'http://127.0.0.1:3000/api/manage/bookManage/showNaddTag',
          data: {id: bangumiId},
          method: 'POST',
          success: function(res) {
            var str = "";
            for(var i in res.data){
              str += '<button class="layui-btn layui-btn-warm tagbtn" data-id=' + res.data[i].id + '>' + res.data[i].name + '</button>';
            }
            $('#tagWrap').append(str);
          }
        });
        },
        btn: ['添加', '关闭'],
        yes: function(index, layero) {//添加对应的标签
          var arrTag = $('#tagWrap').find('.active');
          var arrId  = [];

          for( var i = 0; i < arrTag.length; i++){
            arrId.push($(arrTag[i]).attr('data-id'));
          }
          $.ajax({
            url: 'http://127.0.0.1:3000/api/manage/bookManage/addBanTag',
            data: {arrId: arrId, id: bangumiId},
            method: 'POST',
            success: function(data){
              if(data.code === '11000'){
                layer.msg(data.msg, {icon: 1, time: 1500});
                setTimeout(function(){
                  showAddTag(bangumiId);
                  layer.close(tagIndex);
                }, 2000);
              }
            },
            error: function(err){
              console.log(err);
            }
          })
        },
        btn2: function(index, layero){
          layer.close(tagIndex); 
        }
      }) 
    }
    //显示已关联标签
    function showAddTag(bangumiId){
      $('#addedTagPopup').empty();
      $.ajax({
        url: 'http://127.0.0.1:3000/api/manage/bookManage/showaddTag',
        data: {id: bangumiId},
        method: 'POST',
        success: function(data){
          if(data.data.length != 0){
            var str = "";
            for(var i in data.data){
              str += '<button class="layui-btn layui-btn-warm tagbtn" data-id=' + data.data[i].id + '>' + data.data[i].name + '</button>';
            } 
            $('#addedTagPopup').append(str);
          }
        },
        error: function(err){

        }
      })
    }
    //表格重载
    function tableEpisodeReload(){
      table.reload('episodeData', {
        url: 'http://127.0.0.1:3000/api/manage/bookManage/showOffprint'
        ,page: {
          curr: 1
        }
      });
    }
    //角色头像上传
    function roleUploadImg(popupId, showimgId, imgId, smallimgId, canvasId){
      var uploadInst = upload.render({
        elem: popupId
        ,field: 'logo'
        ,url: 'http://127.0.0.1:3000/api/upload/uploadImage'
        ,before: function(obj){
          //预读本地文件示例，不支持ie8
          obj.preview(function(index, file, result){
            $('#' + showimgId).attr('src', result);

            var reader = new FileReader();
            var img    = new Image();
            var canvas = document.getElementById(canvasId);
            console.log(canvasId);
            var cwidth = canvas.width;
            var cheight = canvas.height;
            var ctx    = canvas.getContext('2d');
            reader.readAsDataURL(file);
            img.onload = function () {
              ctx.drawImage(img, 0, 0, cwidth, cheight, 0, 0, cwidth, cheight);
              canvas.toBlob(function(blob) {
                //图片上传
                var formdata = new FormData();
                var fileType = blob.type.split("/")[1];
                var xhr = new XMLHttpRequest();

                formdata.append("logo", blob, fileType);
                xhr.open('POST', 'http://127.0.0.1:3000/api/upload/uploadSmallImage', true);
                xhr.send(formdata);
                xhr.onload = function(e) { 
                  if(this.status == 200 || this.status == 304){
                    var tempd = JSON.parse(this.responseText);
                      $('#' + smallimgId).val(tempd.path);
                  }
                };
              },file.type || 'image/png');
            }
            reader.onload = function(e) {
              img.src = result;
            }
            
          });
        }
        ,done: function(res){
          if(res.status == '10000'){
            $('#' + imgId).val(res.path);
          }
        }
        ,error: function(){
          console.log("重试");
        }
      });
    }
   });
</script>
</body>
</html>
